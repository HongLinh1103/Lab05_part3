<%- include('../partials/header') %>

<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card">
        <div class="card-header text-center">
          <h4>Đổi Mật Khẩu</h4>
          <small class="text-muted">Xác thực với Session ID để bảo mật</small>
        </div>
        <div class="card-body">
          <!-- Display flash messages -->
          <% if (error && error.length > 0) { %>
            <div class="alert alert-danger">
              <%= error %>
            </div>
          <% } %>
          
          <% if (success && success.length > 0) { %>
            <div class="alert alert-success">
              <%= success %>
            </div>
          <% } %>

          <!-- Session Information -->
          <div class="alert alert-info">
            <h6><i class="fas fa-shield-alt"></i> Thông tin xác thực:</h6>
            <div class="row">
              <div class="col-12">
                <small>
                  <strong>User:</strong> <%= user.username %> (<%= user.email %>)<br>
                  <strong>Session ID:</strong> <span class="font-monospace"><%= sessionId %></span><br>
                  <small class="text-muted">Session ID này sẽ được sử dụng để xác thực yêu cầu đổi mật khẩu</small>
                </small>
              </div>
            </div>
          </div>

          <form action="/auth/change-password" method="POST" id="changePasswordForm">
            <!-- Hidden Session ID for verification -->
            <input type="hidden" name="sessionId" value="<%= sessionId %>">
            
            <div class="form-group mb-3">
              <label for="currentPassword">Mật khẩu hiện tại</label>
              <div class="input-group">
                <input 
                  type="password" 
                  class="form-control" 
                  id="currentPassword" 
                  name="currentPassword" 
                  required
                  placeholder="Nhập mật khẩu hiện tại"
                >
                <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('currentPassword')">
                  <i class="fas fa-eye" id="currentPasswordIcon"></i>
                </button>
              </div>
            </div>
            
            <div class="form-group mb-3">
              <label for="newPassword">Mật khẩu mới</label>
              <div class="input-group">
                <input 
                  type="password" 
                  class="form-control" 
                  id="newPassword" 
                  name="newPassword" 
                  required
                  placeholder="Nhập mật khẩu mới (tối thiểu 6 ký tự)"
                  minlength="6"
                  onkeyup="checkPasswordStrength(); checkPasswordMatch()"
                >
                <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('newPassword')">
                  <i class="fas fa-eye" id="newPasswordIcon"></i>
                </button>
              </div>
              <div id="password-strength" class="mt-1"></div>
            </div>
            
            <div class="form-group mb-3">
              <label for="confirmPassword">Xác nhận mật khẩu mới</label>
              <div class="input-group">
                <input 
                  type="password" 
                  class="form-control" 
                  id="confirmPassword" 
                  name="confirmPassword" 
                  required
                  placeholder="Nhập lại mật khẩu mới để xác nhận"
                  minlength="6"
                  onkeyup="checkPasswordMatch()"
                >
                <button type="button" class="btn btn-outline-secondary" onclick="togglePassword('confirmPassword')">
                  <i class="fas fa-eye" id="confirmPasswordIcon"></i>
                </button>
              </div>
              <div id="password-match-message" class="mt-1"></div>
            </div>

            <!-- Security Notice -->
            <div class="alert alert-warning">
              <small>
                <i class="fas fa-exclamation-triangle"></i> <strong>Lưu ý bảo mật:</strong><br>
                • Sau khi đổi mật khẩu thành công, bạn sẽ bị đăng xuất tự động<br>
                • Cần đăng nhập lại với mật khẩu mới<br>
                • Session ID hiện tại sẽ bị hủy để bảo mật
              </small>
            </div>
            
            <button type="submit" class="btn btn-primary w-100" id="changePasswordBtn">
              <i class="fas fa-key"></i> Đổi Mật Khẩu
            </button>
          </form>
          
          <div class="text-center mt-3">
            <a href="/auth/dashboard" class="btn btn-secondary">
              <i class="fas fa-arrow-left"></i> Quay lại Dashboard
            </a>
            <a href="/auth/profile" class="btn btn-outline-secondary">
              <i class="fas fa-user"></i> Xem Profile
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Password visibility toggle
function togglePassword(fieldId) {
  const field = document.getElementById(fieldId);
  const icon = document.getElementById(fieldId + 'Icon');
  
  if (field.type === 'password') {
    field.type = 'text';
    icon.classList.remove('fa-eye');
    icon.classList.add('fa-eye-slash');
  } else {
    field.type = 'password';
    icon.classList.remove('fa-eye-slash');
    icon.classList.add('fa-eye');
  }
}

// Password strength checker
function checkPasswordStrength() {
  const password = document.getElementById('newPassword').value;
  const strengthDiv = document.getElementById('password-strength');
  
  if (password === '') {
    strengthDiv.innerHTML = '';
    return;
  }
  
  let strength = 0;
  let strengthText = '';
  let strengthClass = '';
  
  // Length check
  if (password.length >= 8) strength++;
  if (password.length >= 12) strength++;
  
  // Character variety
  if (/[a-z]/.test(password)) strength++;
  if (/[A-Z]/.test(password)) strength++;
  if (/[0-9]/.test(password)) strength++;
  if (/[^A-Za-z0-9]/.test(password)) strength++;
  
  switch(strength) {
    case 0-2:
      strengthText = 'Yếu';
      strengthClass = 'text-danger';
      break;
    case 3-4:
      strengthText = 'Trung bình';
      strengthClass = 'text-warning';
      break;
    case 5-6:
      strengthText = 'Mạnh';
      strengthClass = 'text-success';
      break;
  }
  
  strengthDiv.innerHTML = `<small class="${strengthClass}">Độ mạnh: ${strengthText}</small>`;
}

// Password match checker
function checkPasswordMatch() {
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  const messageDiv = document.getElementById('password-match-message');
  const submitBtn = document.getElementById('changePasswordBtn');
  
  if (confirmPassword === '') {
    messageDiv.innerHTML = '';
    submitBtn.disabled = false;
    return;
  }
  
  if (newPassword === confirmPassword) {
    messageDiv.innerHTML = '<small class="text-success"><i class="fas fa-check"></i> Mật khẩu khớp</small>';
    submitBtn.disabled = false;
  } else {
    messageDiv.innerHTML = '<small class="text-danger"><i class="fas fa-times"></i> Mật khẩu không khớp</small>';
    submitBtn.disabled = true;
  }
}

// Form submission confirmation
document.getElementById('changePasswordForm').addEventListener('submit', function(e) {
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  if (!currentPassword || !newPassword || !confirmPassword) {
    e.preventDefault();
    alert('Vui lòng điền đầy đủ tất cả các trường!');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    e.preventDefault();
    alert('Mật khẩu mới và xác nhận mật khẩu không khớp!');
    return;
  }
  
  if (newPassword.length < 6) {
    e.preventDefault();
    alert('Mật khẩu mới phải có ít nhất 6 ký tự!');
    return;
  }
  
  if (currentPassword === newPassword) {
    e.preventDefault();
    alert('Mật khẩu mới phải khác mật khẩu hiện tại!');
    return;
  }
  
  // Final confirmation
  if (!confirm('Bạn có chắc chắn muốn đổi mật khẩu? Sau khi đổi thành công, bạn sẽ bị đăng xuất và cần đăng nhập lại.')) {
    e.preventDefault();
    return;
  }
});
</script>

<%- include('../partials/footer') %>
